<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Books - Pycelium</title>
    <link rel="stylesheet" href="./dist/output.css">
    <style>
        .row-hidden {
            display: none;
        }
        
        .sortable-header {
            cursor: pointer;
            user-select: none;
            transition: background-color 0.2s ease;
        }
        
        .sortable-header:hover {
            background-color: rgba(75, 85, 99, 0.5);
        }
        
        .sort-indicator {
            margin-left: 8px;
            font-size: 0.8em;
            opacity: 0.7;
        }
        
        .sort-indicator.sort-asc::after {
            content: ' ↑';
        }
        
        .sort-indicator.sort-desc::after {
            content: ' ↓';
        }
        
        .filter-tag {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            background-color: rgba(59, 130, 246, 0.8);
            color: white;
            border-radius: 16px;
            font-size: 14px;
            transition: all 0.2s ease;
            animation: fadeIn 0.2s ease;
        }
        
        .filter-tag:hover {
            background-color: rgba(59, 130, 246, 1);
            transform: translateY(-1px);
        }
        
        .filter-tag .remove-filter {
            cursor: pointer;
            background: none;
            border: none;
            color: white;
            font-size: 16px;
            font-weight: bold;
            padding: 0;
            margin: 0;
            width: 16px;
            height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: background-color 0.2s ease;
        }
        
        .filter-tag .remove-filter:hover {
            background-color: rgba(0, 0, 0, 0.2);
        }
        
        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.8);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
    </style>
</head>
<body class="bg-dark-background text-light-text font-sans">
    <nav class="bg-dark-secondary sticky top-0 z-10">
        <div class="container mx-auto px-4">
            <div class="flex items-center justify-center h-16">
                <div class="hidden md:block">
                    <div class="flex items-center space-x-4">
                        <a href="/" class="text-dark-text hover:text-white px-3 py-2 rounded-md text-sm font-medium">Home</a>
                        <a href="/about.html" class="text-dark-text hover:text-white px-3 py-2 rounded-md text-sm font-medium">About</a>
                        <a href="/projects.html" class="text-dark-text hover:text-white px-3 py-2 rounded-md text-sm font-medium">Projects</a>
                        <a href="/goals.html" class="text-dark-text hover:text-white px-3 py-2 rounded-md text-sm font-medium">Goals</a>
                        <a href="/community.html" class="text-dark-text hover:text-white px-3 py-2 rounded-md text-sm font-medium">Community</a>
                        <a href="/books.html" class="text-white px-3 py-2 rounded-md text-sm font-medium" aria-current="page">Books</a>
                    </div>
                </div>
            </div>
        </div>
    </nav>

    <header class="py-12 text-center">
        <h1 class="text-4xl font-bold text-white">Some Books</h1>
    </header>

    <main class="container mx-auto px-4">
        <section class="mb-16">
            <div class="flex flex-col sm:flex-row gap-4 items-start sm:items-center">
                <div class="flex-1 w-full sm:w-auto">
                    <input 
                        type="text" 
                        id="search-input" 
                        placeholder="Search books..." 
                        class="w-full px-4 py-2 border border-gray-400 dark:border-gray-500 bg-dark-secondary text-light-text rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
                    >
                </div>
                <button 
                    id="add-filter" 
                    class="px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-md transition-colors duration-200 whitespace-nowrap"
                >
                    Add Filter
                </button>
                <button 
                    id="reset-filter" 
                    class="px-4 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-md transition-colors duration-200 whitespace-nowrap"
                >
                    Reset Filter(s)
                </button>
            </div>
            <div id="filter-tags" class="mt-2 mb-2 flex flex-wrap gap-2 min-h-[32px]"></div>
            <table id="books-table" class="border-collapse border-spacing-2 border border-gray-400 dark:border-gray-500">
                <thead>
                    <tr></tr>
                </thead>
                <tbody></tbody>
            </table>
            <div class="py-4">Note: a status of "limbo" means "I read a substantial amount and then put it down".</div>
        </section>
    </main>

    <footer class="bg-dark-secondary text-center py-4">
        <p class="text-dark-text">Copyright 2026 - The Pycelium Company</p>
    </footer>
    <script type="module" src="/src/main.js"></script>
    <script>
        function $(selector) {
            return document.querySelectorAll(selector);
        }

        function $new(element, options) {
            const e = document.createElement(element);
            for (key in options) {
                e[key] = options[key];
            }
            return e;
        }

        // Global state variables
        let currentSortColumn = -1;
        let currentSortDirection = 'none'; // 'none', 'asc', 'desc'
        let allRowsData = [];
        let columnNames = [];
        let originalRowOrder = [];
        let activeFilters = []; // Array of filter objects: { id, value, timestamp }
        let tempFilter = ''; // Current input value that hasn't been saved yet
        let filterIdCounter = 0;

        // Debounce utility function
        function debounce(func, delay) {
            let timeoutId;
            return function (...args) {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(this, args), delay);
            };
        }

        // Initialize the table with books data
        async function initializeTable() {
            const response = await fetch('assets/books.json');
            const books_data = await response.json();
            
            const thead = $('#books-table > thead > tr')[0];
            const tbody = $('#books-table > tbody')[0];
            
            // Clear existing content
            thead.innerHTML = '';
            tbody.innerHTML = '';
            
            // Store column names and create headers
            columnNames = Object.keys(books_data);
            const formatted_books = [];
            
            columnNames.forEach((colname, colIndex) => {
                let column = books_data[colname];
                
                // Create sortable header
                let th = $new('th', {
                    classList: 'p-2 text-left text-xl border border-gray-300 dark:border-gray-600 bg-gray-700 bg-opacity-30 sortable-header',
                    innerText: colname
                });
                
                // Add sort indicator span
                let sortIndicator = $new('span', { className: 'sort-indicator' });
                th.appendChild(sortIndicator);
                
                // Add click handler for sorting
                th.addEventListener('click', () => handleHeaderClick(colIndex));
                
                thead.appendChild(th);
                
                // Format the book data
                for (let i = 0; i < column.length; i++) {
                    if (formatted_books.length < i + 1) {
                        formatted_books.push([]);
                    }
                    let book = formatted_books[i];
                    book.push(column[i]);
                }
            });
            
            // Cache the formatted data
            allRowsData = formatted_books;
            
            // Create all table rows
            allRowsData.forEach((book, rowIndex) => {
                let tr = $new('tr', { classList: 'book-row' });
                
                book.forEach((field, colIndex) => {
                    let th = $new('th', {
                        classList: 'px-2 text-left border border-gray-300 dark:border-gray-700 bg-gray-900 bg-opacity-30',
                        innerText: field
                    });
                    tr.appendChild(th);
                });
                
                tbody.appendChild(tr);
                originalRowOrder.push(tr);
            });
        }

        // Handle header click for sorting
        function handleHeaderClick(columnIndex) {
            // Cycle through sort states: none -> asc -> desc -> none
            if (currentSortColumn === columnIndex) {
                if (currentSortDirection === 'none') {
                    currentSortDirection = 'asc';
                } else if (currentSortDirection === 'asc') {
                    currentSortDirection = 'desc';
                } else {
                    currentSortDirection = 'none';
                    // Keep currentSortColumn for restoration, don't set to -1 yet
                }
            } else {
                currentSortColumn = columnIndex;
                currentSortDirection = 'asc';
            }
            
            updateSortIndicators();
            applyFilterAndSort();
            
            // Only set to -1 after applying sort to ensure proper restoration
            if (currentSortDirection === 'none') {
                currentSortColumn = -1;
            }
        }

        // Update visual sort indicators
        function updateSortIndicators() {
            const headers = $('#books-table thead th');
            headers.forEach((header, index) => {
                const indicator = header.querySelector('.sort-indicator');
                indicator.className = 'sort-indicator';
                
                if (index === currentSortColumn) {
                    if (currentSortDirection === 'asc') {
                        indicator.classList.add('sort-asc');
                    } else if (currentSortDirection === 'desc') {
                        indicator.classList.add('sort-desc');
                    }
                }
            });
        }

        // Check if a column should be sorted numerically
        function isNumericColumn(columnIndex) {
            const columnName = columnNames[columnIndex].toLowerCase();
            return columnName.includes('year') || columnName.includes('score') || columnName === 'pdf';
        }

        // Compare function for sorting
        function compareValues(a, b, isNumeric) {
            if (isNumeric) {
                const numA = parseFloat(a) || 0;
                const numB = parseFloat(b) || 0;
                return numA - numB;
            } else {
                return String(a).localeCompare(String(b));
            }
        }

        // Filter and sort the table
        function applyFilterAndSort() {
            const tbody = $('#books-table > tbody')[0];
            const allRows = tbody.querySelectorAll('tr.book-row');
            
            // Apply filtering
            allRows.forEach((row, rowIndex) => {
                let shouldShow = activeFilters.length === 0 && tempFilter === ''; // Show all if no filters
                
                if (activeFilters.length > 0 || tempFilter !== '') {
                    // Create array of all filters to check (permanent + temporary)
                    const allFiltersToCheck = [
                        ...activeFilters.map(f => f.value.toLowerCase()),
                        ...(tempFilter !== '' ? [tempFilter.toLowerCase()] : [])
                    ];
                    
                    // Row must match ALL filters (AND logic)
                    shouldShow = allFiltersToCheck.every(filterValue => {
                        const cells = row.querySelectorAll('th');
                        
                        // Check if any cell contains the filter value
                        for (let cell of cells) {
                            if (cell.textContent.toLowerCase().includes(filterValue)) {
                                return true;
                            }
                        }
                        return false;
                    });
                }
                
                row.classList.toggle('row-hidden', !shouldShow);
            });
            
            // Apply sorting to visible rows
            const visibleRows = Array.from(allRows).filter(row => !row.classList.contains('row-hidden'));
            
            if (currentSortColumn >= 0 && currentSortDirection !== 'none') {
                // Apply sorting
                const isNumeric = isNumericColumn(currentSortColumn);
                
                visibleRows.sort((rowA, rowB) => {
                    const cellA = rowA.querySelectorAll('th')[currentSortColumn];
                    const cellB = rowB.querySelectorAll('th')[currentSortColumn];
                    const valueA = cellA.textContent.trim();
                    const valueB = cellB.textContent.trim();
                    
                    const comparison = compareValues(valueA, valueB, isNumeric);
                    return currentSortDirection === 'asc' ? comparison : -comparison;
                });
            } else {
                // Restore original order when sort is reset
                visibleRows.sort((rowA, rowB) => {
                    const indexA = originalRowOrder.indexOf(rowA);
                    const indexB = originalRowOrder.indexOf(rowB);
                    return indexA - indexB;
                });
            }
            
            // Reorder visible rows in DOM
            visibleRows.forEach(row => tbody.appendChild(row));
        }

        // Add a new filter
        function addFilter() {
            // Use the tempFilter value (already captured from input)
            const filterValue = tempFilter;
            
            if (filterValue === '') {
                return; // Don't add empty filters
            }
            
            // Check if this filter already exists
            const existingFilter = activeFilters.find(filter => 
                filter.value.toLowerCase() === filterValue.toLowerCase()
            );
            
            if (existingFilter) {
                return; // Don't add duplicate filters
            }
            
            // Create new filter object
            const newFilter = {
                id: ++filterIdCounter,
                value: filterValue,
                timestamp: Date.now()
            };
            
            activeFilters.push(newFilter);
            createFilterTag(newFilter);
            
            // Clear input field and tempFilter
            document.getElementById('search-input').value = '';
            tempFilter = '';
            
            // Apply filters (without resetting sort)
            applyFilterAndSort();
        }
        
        // Remove a specific filter
        function removeFilter(filterId) {
            activeFilters = activeFilters.filter(filter => filter.id !== filterId);
            
            // Remove the tag element
            const tagElement = document.querySelector(`[data-filter-id="${filterId}"]`);
            if (tagElement) {
                tagElement.remove();
            }
            
            // Apply remaining filters
            applyFilterAndSort();
        }
        
        // Create a filter tag element
        function createFilterTag(filter) {
            const filterTagsContainer = document.getElementById('filter-tags');
            
            const tagElement = document.createElement('div');
            tagElement.className = 'filter-tag';
            tagElement.setAttribute('data-filter-id', filter.id);
            
            const labelElement = document.createElement('span');
            labelElement.textContent = filter.value;
            
            const removeButton = document.createElement('button');
            removeButton.className = 'remove-filter';
            removeButton.innerHTML = '×';
            removeButton.setAttribute('aria-label', `Remove filter: ${filter.value}`);
            removeButton.addEventListener('click', () => removeFilter(filter.id));
            
            tagElement.appendChild(labelElement);
            tagElement.appendChild(removeButton);
            
            filterTagsContainer.appendChild(tagElement);
        }
        

        
        // Clear all filter tags from the DOM
        function clearAllFilterTags() {
            const filterTagsContainer = document.getElementById('filter-tags');
            filterTagsContainer.innerHTML = '';
        }
        
        // Filter function (debounced)
        const debouncedFilter = debounce(() => {
            // Capture current input value as temporary filter
            tempFilter = document.getElementById('search-input').value.trim();
            
            currentSortColumn = -1;
            currentSortDirection = 'none';
            updateSortIndicators();
            applyFilterAndSort();
        }, 300);

        // Reset filter function
        function resetFilter() {
            document.getElementById('search-input').value = '';
            tempFilter = '';
            activeFilters = [];
            clearAllFilterTags();
            currentSortColumn = -1;
            currentSortDirection = 'none';
            updateSortIndicators();
            applyFilterAndSort();
        }

        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', () => {
            initializeTable();
            
            // Add event listeners
            const searchInput = document.getElementById('search-input');
            searchInput.addEventListener('input', debouncedFilter);
            searchInput.addEventListener('keydown', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    addFilter();
                }
            });
            
            document.getElementById('add-filter').addEventListener('click', addFilter);
            document.getElementById('reset-filter').addEventListener('click', resetFilter);
        });
    </script>
</body>
</html>
